<style>
  /* セクション全体をカード風に */
  .result-card {
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 0 6px rgba(0, 0, 0, 0.1);
    margin-bottom: 2rem;
    padding: 1.5rem;
  }

  .section-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  .answer-table {
    width: 100%;
    border-collapse: collapse;
  }

  .answer-table th,
  .answer-table td {
    border: 1px solid #dee2e6;
    padding: 0.6em 0.9em;
    text-align: center;
  }

  .answer-table thead {
    background-color: #f8f9fa;
  }

  .answer-color-0 { background-color: #ffe6e9; }
  .answer-color-1 { background-color: #e6f7d4; }
  .answer-color-2 { background-color: #d9ecff; }
  .answer-color-3 { background-color: #fff2cc; }
  .answer-color-4 { background-color: #f0e6ff; }

  .answer-badge {
    display: inline-block;
    padding: 0.25em 0.5em;
    margin: 0.1em;
    border-radius: 0.5em;
    font-size: 0.9em;
    font-weight: 500;
  }

  .highlight-row {
    background-color: #d4edda;
    font-weight: bold;
  }
</style>

<div class="result-card">
  <div class="section-title">📅 参加可能日ごとの参加者</div>
  <table class="answer-table">
    <thead>
      <tr>
        <th>日付</th>
        <th>参加者数</th>
        <th>参加者名</th>
      </tr>
    </thead>
    <tbody>
      {% for date in available_dates %}
        <tr>
          <td>{{ date }}</td>
          <td>{{ date_participants.get(date, []) | length }}</td>
          <td>
            {% set participants = date_participants.get(date, []) %}
            {% if participants %}
              {{ participants | join(', ') }}
            {% else %}
              -
            {% endif %}
          </td>
        </tr>
      {% endfor %}
    </tbody>
  </table>
</div>


<!-- 参加者ごとの詳細テーブル -->
<div class="result-card">
  <div class="section-title">🧍‍♂️ 参加者ごとの回答詳細</div>
  <table class="answer-table">
    <thead>
      <tr>
        <th>参加者名</th>
        <th>参加可能日</th>
        {% for q in questions %}
          <th>{{ q.text }}</th>
        {% endfor %}
      </tr>
    </thead>
    <tbody>
      {% for p in participant_answers %}
        <tr>
          <td><strong>{{ p.name }}</strong></td>
          <td>{{ p.selected_dates | join(', ') }}</td>
          {% for q in questions %}
            {% set answer = p.answers.get(q.id) %}
            {% if answer %}
              {% if q.type == 'radio' %}
                {% set options = q.options | map(attribute='text') | list %}
                {% set idx = options.index(answer) if answer in options else -1 %}
                <td class="answer-color-{{ idx if idx >= 0 else 0 }}">{{ answer }}</td>
              {% elif q.type == 'checkbox' %}
                {% set options = q.options | map(attribute='text') | list %}
                {% set answer_list = answer.split(',') %}
                <td>
                  {% for ans in answer_list %}
                    {% set idx = options.index(ans.strip()) if ans.strip() in options else -1 %}
                    <span class="answer-badge answer-color-{{ idx if idx >= 0 else 0 }}">{{ ans.strip() }}</span>
                  {% endfor %}
                </td>
              {% else %}
                <td>{{ answer }}</td>
              {% endif %}
            {% else %}
              <td>-</td>
            {% endif %}
          {% endfor %}
        </tr>
      {% endfor %}

      <!-- 最終行：最多投票 -->
      <tr class="highlight-row">
        <td>最多投票</td>
        <td>{{ most_selected_dates | join(', ') }}</td>
        {% for q in questions %}
          {% if q.type == 'radio' or q.type == 'checkbox' %}
            {% set most_answers = question_most_answers.get(q.id, []) %}
            {% if most_answers %}
              {% set options = q.options | map(attribute='text') | list %}
              <td>
                {% for ans in most_answers %}
                  {% set idx = options.index(ans) if ans in options else -1 %}
                  <span class="answer-badge answer-color-{{ idx if idx >= 0 else 0 }}">{{ ans }}</span>
                {% endfor %}
              </td>
            {% else %}
              <td>-</td>
            {% endif %}
          {% else %}
            <td>-</td>
          {% endif %}
        {% endfor %}
      </tr>
    </tbody>
  </table>
</div>
